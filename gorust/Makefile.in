LIBRUST = @LIBRUST@
CARGO_FLAGS = @CARGO_FLAGS@

all: Makefile config.subst build

bridge/hash.c: $(LIBRUST)/librust.a Makefile
	@if test $< -nt $@ || test Makefile -nt $@; then \
		echo calculating shasum $@; \
		echo "const char *___shasum = \"`shasum $< | awk '{ print $$1; }'`\";"  > $@;  \
	fi

.PHONY: $(LIBRUST)/librust.a

$(LIBRUST)/librust.a:
	cd rust && cargo build $(CARGO_FLAGS)

build: bridge/bridge.go bridge/hash.c 
	go build

config.subst: configure
	./config.reconf

Makefile: Makefile.in
	./config.subst

bridge/bridge.go: bridge/bridge.go.in
	./config.subst

